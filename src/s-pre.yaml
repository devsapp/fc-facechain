edition: 3.0.0 #  命令行YAML规范版本，遵循语义化版本（Semantic Versioning）规范
name: fc-stable-diffusion
access: default
vars:
  imageUrl: registry.cn-shanghai.aliyuncs.com/aliyun-fc/fc-facechain:v1
  region: cn-shanghai
  namespace: facechain # 

resources:
  facechain:
    component: fc3
    props:
      region: ${vars.region}
      functionName: "${vars.namespace}-server"
      description: facechain 函数
      handler: index.handler
      timeout: 3600
      diskSize: 512
      caPort: 7860
      instanceType: fc.gpu.ampere.1
      runtime: custom-container
      cpu: 8
      customContainerConfig:
        image: ${vars.imageUrl}
        port: 7860
      instanceConcurrency: 100
      memorySize: 32768
      gpuMemorySize: 24576
      nasConfig: auto
      logConfig: auto
      environmentVariables:
        TRANSFORMERS_OFFLINE: 1
  initial:
    component: fc3
    actions: 
      post-deploy:
        - component: fc3 invoke --function ${this.props.functionName} 
    props:
      region: ${vars.region}
      functionName: "${vars.namespace}-init"
      description: 模型初始化函数
      handler: index.handler
      timeout: 3600
      diskSize: 512
      codeUri: './initial'
      runtime: custom-container
      nasConfig: ${resources.facechain.output.nasConfig}
      logConfig: auto
      # cpu: 16
      # memorySize: 32768
      instanceConcurrency: 1
      instanceType: fc.gpu.tesla.1
      customContainerConfig:
        image: ${vars.imageUrl}
        port: 7860
        entrypoint:
          - initial/initial.sh
        webServerMode: false
      cpu: 8
      memorySize: 32768
      gpuMemorySize: 16384

  custom-domain:
    component: fc3-domain
    props: #  组件的属性值
      region: ${vars.region} 
      domainName: auto
      protocol: HTTP
      routeConfig:
        routes:
          - functionName: ${resources.facechain.props.functionName}
            methods:
              - GET
              - POST
              - PUT
              - DELETE
            path: /*
            qualifier: LATEST