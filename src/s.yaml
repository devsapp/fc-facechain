edition: 3.0.0 #  命令行YAML规范版本，遵循语义化版本（Semantic Versioning）规范
name: fc-facechain-v3
access: '{{ access }}'
vars:
  imageUrl: registry.{{region}}.aliyuncs.com/aliyun-fc/fc-facechain:v2
  region: "{{region}}"
  namespace: "{{namespace}}"

resources:
  facechain:
    component: fc3@0.0.21
    props:
      region: ${vars.region}
      functionName: "${vars.namespace}-server"
      description: facechain 函数
      handler: index.handler
      timeout: 3600
      diskSize: 512
      caPort: 7860
      instanceType: fc.gpu.ampere.1
      runtime: custom-container
      cpu: 8
      memorySize: 32768
      gpuConfig:
        gpuMemorySize: 24576
        gpuType: fc.gpu.ampere.1
      customContainerConfig:
        image: ${vars.imageUrl}
        port: 7860
        entrypoint: 
          - /entrypoint.sh
      instanceConcurrency: 100
      vpcConfig: auto
      nasConfig: auto
      {{ if enableSLS === true }}logConfig: auto{{ /if }}
      environmentVariables:
        TRANSFORMERS_OFFLINE: "1"

  initial:
    component: fc3@0.0.21
    actions: 
      success-deploy:
        # - component: fc3 invoke
        - run: |
            s cli fc3 invoke --region ${this.props.region} --function-name ${this.props.functionName} --timeout 1200 -a {{ access }}
          path: ./
    props:
      region: ${vars.region}
      functionName: "${vars.namespace}-init"
      description: 模型初始化函数
      handler: index.handler
      timeout: 3600
      diskSize: 512
      codeUri: './initial'
      runtime: custom-container
      vpcConfig: ${resources.facechain.output.vpcConfig}
      nasConfig: ${resources.facechain.output.nasConfig}
      {{ if enableSLS === true }}logConfig: auto{{ /if }}
      instanceConcurrency: 1
      cpu: 8
      memorySize: 32768
      gpuConfig:
        gpuMemorySize: 16384
        gpuType: fc.gpu.tesla.1
      customContainerConfig:
        image: ${vars.imageUrl}
        port: 9000
        entrypoint:
          - python3
        command:
          - /initial/main.py
        webServerMode: false
      gpuMemorySize: 16384
      environmentVariables:
        NAS_ROOT: "/mnt/${resources.facechain.props.functionName}"

  custom-domain:
    component: fc3-domain
    props: #  组件的属性值
      region: ${vars.region} 
      domainName: auto
      protocol: HTTP
      routeConfig:
        routes:
          - functionName: ${resources.facechain.props.functionName}
            methods:
              - GET
              - POST
              - PUT
              - DELETE
            path: /*
            qualifier: LATEST